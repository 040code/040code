<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A developers blog">

    <title>Service Discovery on AWS - 040 Code</title>

    <link rel="canonical" href="https://040code.github.io//2018/02/14/service-discovery/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="https://040code.github.io//feed.xml" title="040 Code" />

    

    


</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">040 Code</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                  
                  <li>
                      <a href="/author/niek/">Niek Palm</a>
                  </li>


                  
                
                  
                  <li>
                      <a href="/author/maarten/">Maarten Metz</a>
                  </li>


                  
                
                  
                  <li>
                      <a href="/author/jeroen/">Jeroen Knoops</a>
                  </li>


                  
                
            </ul>

        </div>


        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    



<!-- Post Header -->
<header class="intro-header" style="background-image: url('/assets/2018-02-14-service-discovery/holstlaan-dommel.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Service Discovery on AWS</h1>
                    
                    <h2 class="subheading">Enabling discovery for Spring Cloud on AWS ECS</h2>
                    
                    <span class="meta">Posted by:
                      
                          <a href="/author/niek/">
                            Niek Palm
                          </a>
                          
                      
                      on 2018-02-14</span>
                </div>
            </div>
        </div>
    </div>
</header>



<!-- Post Content -->
<section>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">


        <a class="badge " href="/blog/tag/aws/">Amazon</a><a class="badge " href="/blog/tag/spring/">Spring Framework</a><a class="badge " href="/blog/tag/docker/">Docker</a>


				<p>Last year I wrote a <a href="/2017/04/20/discovery-agent/">post</a> how to implement service discovery for Spring Boot applications running in Docker containers on AWS ECS. At that time the Amazon ECS agent does not have support to discover the docker exposed ports inside the container. In November 2017 Amazon released a feature in the <a href="https://github.com/aws/amazon-ecs-agent/releases/tag/v1.15.0">ECS agent 1.15</a> to retrieve container meta data in the container. This feature makes the discovery agent obsolete.</p>

<h3 id="the-problem">The problem</h3>
<p>Looking back to the last years problem. A Spring service running in a container needs its external ip address and port to register to Eureka for service discovery. A service running in a container does not know the external exposed port and docker does not support a way to obtain the port mapping. We could inject the ip address but for the port that would not work. Since the port is unknown at start time. Of course, this in only valid when using random ports. But fixing the port can eventually cause port conflicts. Besides that, you are not able to scale the container on the same host. Therefore, it makes sense to use automatic port assignment.</p>

<p>At that time I have solved this problem by adding an agent that can be called via a REST interface to lookup the exposed port based on the container id and internal port. The agent returns the external port, and the service can use this information to register itself to Eureka. This approach worked well but since the ECS agent is now shipped with a feature to retrieve the meta data we do not need longer an extra agent anymore.</p>

<p><a href="#">
    <img src="/img/ecs1.png" height="80%" width="80%" alt="ECS" />
</a></p>

<h3 id="solution">Solution</h3>
<p>The approach to register the container to the discovery service remains the same. During container startup, the start script obtains the external ip address, and docker exposed port. The discovered information will be passed to the Spring Boot application using environment variables. At application start the Spring service discovery client uses the environment variables to register the application to Eureka.</p>

<p><a href="#">
    <img src="/assets/2018-02-14-service-discovery/sequence.png" height="100%" width="98%" alt="Sequence Diagram" />
</a></p>

<p>Before we are able retrieve information about the container (in the container) we need to enable the feature on the ECS instance. For more details about this feature see the <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/container-metadata.html">Amazon documentation</a>. To enable the meta data in the container you need to set <code class="highlighter-rouge">ECS_ENABLE_CONTAINER_METADATA</code> to <code class="highlighter-rouge">true</code>. This can be easily done by adding the line below the user data script.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo ECS_ENABLE_CONTAINER_METADATA=true &gt;&gt; /etc/ecs/ecs.config
</code></pre></div></div>

<p>Now each created container by ECS on the EC2 instances will have the meta data available in the file assigned to the environment variable <code class="highlighter-rouge">ECS_CONTAINER_METADATA_FILE</code>. An example of the meta data looks like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "Cluster": "ecs-cluster",
  "ContainerInstanceARN": "arn:aws:ecs:eu-west-1:1234445678:some-id",
  "TaskARN": "arn:aws:ecs:eu-west-1:1234445678:some-other-id",
  "ContainerID": "container-id",
  "ContainerName": "my-service",
  "DockerContainerName": "docker-container-name",
  "ImageID": "image-id",
  "ImageName": "docker-image",
  "PortMappings": [
    {
      "ContainerPort": 8080,
      "HostPort": 320001,
      "BindIp": "0.0.0.0",
      "Protocol": "tcp"
    }
  ],
  "Networks": [
    {
      "NetworkMode": "default",
      "IPv4Addresses": [
        "172.17.0.2"
      ]
    }
  ],
  "MetadataFileStatus": "READY"
}
</code></pre></div></div>

<p>Next we fetch the ip address and port during container start. The ip address we still get through the standard amazon info endpoint.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export EUREKA_INSTANCE_IP_ADDRESS=$(curl --retry 5 --connect-timeout 3 -s 169.254.169.254/latest/meta-data/local-ipv4)
</code></pre></div></div>

<p>We extract the port mapping from the metadata using <code class="highlighter-rouge">jq</code>. We assume the service will run in the container on port 8080. Otherwise you can make this configurable as well.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export EUREKE_INSTANCE_NON_SECURE_PORT=$(cat ${ECS_CONTAINER_METADATA_FILE} | jq -c -r ".PortMappings[] | select(.ContainerPort == 8080) | .HostPort")
</code></pre></div></div>
<p>By using the Spring properties as environment variables, we can inject the information to the Spring application. Alternatively, you can use other names and assign the values in the <code class="highlighter-rouge">application.yml</code> file, see the example below.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>eureka:
  instance:
    preferIpAddress: true
    ip-address: ${EXTERNAL_IP}
    non-secure-port: ${EXTERNAL_PORT}
</code></pre></div></div>

<p>With this approach the discovery agent becomes obsolete and we can retrieve the information for discovery through standard Amazon features. The example I have described in this post is just one way to implement service discovery in ECS, many alternatives are available.</p>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/01/30/fargate_with_terraform/" data-toggle="tooltip" data-placement="top" title="MicroHack Fargate">&larr; Previous Post</a>
                    </li>
                    
                    
                </ul>

            </div>
        </div>
    </div>
</section>




<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://www.linkedin.com/in/niekpalm">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/niekos77">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/npalm">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul> -->
                <p class="copyright text-muted">Copyright &copy; 040 Code 2018</p>
            </div>
        </div>
    </div>
</footer>

<!-- Disqus -->



<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-97020149-1', 'auto');
  ga('send', 'pageview');

</script>



</body>

</html>
