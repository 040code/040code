<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A developers blog">

    <title>Cloud Run - 040 Code</title>

    <link rel="canonical" href="https://040code.github.io//2019/04/18/cloudrun/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="https://040code.github.io//feed.xml" title="040 Code" />

    

    
    <link rel="stylesheet" type="text/css" href="/css/asciinema-player.css" />
    <script src="/js/asciinema-player.js"></script>
    


</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">040 Code</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                  
                  <li>
                      <a href="/author/niek/">Niek Palm</a>
                  </li>


                  
                
                  
                  <li>
                      <a href="/author/maarten/">Maarten Metz</a>
                  </li>


                  
                
                  
                  <li>
                      <a href="/author/jeroen/">Jeroen Knoops</a>
                  </li>


                  
                
                  
                  <li>
                      <a href="/author/stefan/">Stefan van den Oord</a>
                  </li>


                  
                
            </ul>

        </div>


        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    



<!-- Post Header -->
<header class="intro-header" style="background-image: url('/assets/2019-04-18_cloudrun/skybar-nh.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Cloud Run</h1>
                    
                    <h2 class="subheading">Bringing serverless to containers</h2>
                    
                    <span class="meta">Posted by:
                      
                          <a href="/author/niek/">
                            Niek Palm
                          </a>
                          
                      
                      on 2019-04-18</span>
                </div>
            </div>
        </div>
    </div>
</header>



<!-- Post Content -->
<section>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">


        <a class="badge " href="/blog/tag/cloud/">Cloud</a><a class="badge " href="/blog/tag/google/">Google</a><a class="badge " href="/blog/tag/docker/">Docker</a>


				<h2 id="introduction">Introduction</h2>
<p>Last week at the <a href="https://cloud.withgoogle.com/next/sf/">Google Next</a> in San Francisco, Google announced <a href="https://cloud.google.com/run/">Cloud Run</a>. A new platform to enable developers without any infrastructure to run Docker containers on Google Cloud.</p>

<blockquote>
  <p>Cloud Run is a managed compute platform that enables you to run stateless containers that are invocable via HTTP requests. Cloud Run is serverless: it abstracts away all infrastructure management, so you can focus on what matters most â€” building great applications. It is built from <a href="https://github.com/knative/">Knative</a>, letting you choose to run your containers either fully managed with Cloud Run, or in your Google Kubernetes Engine cluster with Cloud Run on GKE.</p>
</blockquote>

<p><a href="#">
    <img src="/assets/2019-04-18_cloudrun/next.jpg" alt="Model" />
</a></p>

<p>Time the see how this new feature on the Google Platform really works. There are two ways to use Cloud Run. You can choose to run the container serverless, which means you do not have to create any infrastructure. The other option is deploy the container via the Cloud Run to a GKE cluster. From developers perspective there is no difference, the developer can still use the same Cloud Run API.</p>

<p>Lets quickly compare Cloud Run to some other option to run an application sereverless in the cloud. For example you can use <a href="https://zeit.co/now">Now</a> from Zeit to quickly run a serverless application build in many languages, some major are Node, Rust, Static, Python, Go and NextJS. The free tier get you started quickly. In the paid tier you pay for traffic and invocations. <a href="https://aws.amazon.com/fargate/">Fargate</a> the the AWS approach to enable serverless Docker containers. But in Fargate you container is always running and you pay per second for CPU and memory. Read <a href="https://040code.github.io/2018/01/30/fargate_with_terraform/">here</a> more about deploying to Fargate.</p>

<h2 id="deploy-the-040-blog-to-cloud-run">Deploy the 040 blog to Cloud Run</h2>

<p>Why not see if we can publish this blog to Cloud Run. Starting is quit simple, just follow the Google documentation. Go to the Google Cloud console and navigate to Cloud Run. You will see here that deploying a container requires two steps. First publish the Docker image to the Docker registry in your Google project. Next deploy the docker image to Cloud Run.</p>

<h3 id="prepare-your-image">Prepare your image</h3>

<p>On the Cloud Run create service page is clearly mentioned that the containers needs support injection of a port that listen for HTTP traffic via the environment variable <code class="highlighter-rouge">PORT</code>. This is for example easy to support via the Spring Boot framework. But for the blog we allready have an <a href="https://www.nginx.com/">NGINX</a> container which not support injection of the port.</p>

<p>The first step will be to enable port injection to our blog runtime container. Which can be done by starting the container via a wrapper script which update the NGNIX configuration. We define a simple server configuration in which we can replace the <code class="highlighter-rouge">NGNIX_PORT</code> environment variable via <a href="https://www.gnu.org/software/gettext/manual/html_node/envsubst-Invocation.html">envsubst</a>.</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       $<span class="p">{</span><span class="kn">NGNIX_PORT</span><span class="err">}</span><span class="p">;</span>
    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
<span class="kn">...</span>
<span class="err">}</span>
</code></pre></div></div>

<p>Next we create a simple <code class="highlighter-rouge">bash</code> script to update the <code class="highlighter-rouge">PORT</code> at container start. If no port is set, we apply use the default port <code class="highlighter-rouge">80</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">export </span><span class="nv">NGNIX_PORT</span><span class="o">=</span><span class="k">${</span><span class="nv">PORT</span>:<span class="p">=80</span><span class="k">}</span>
envsubst &lt; /etc/nginx/conf.d/mysite.template <span class="o">&gt;</span> /etc/nginx/conf.d/default.conf <span class="se">\</span>
  <span class="o">&amp;&amp;</span> <span class="nb">exec </span>nginx <span class="nt">-g</span> <span class="s1">'daemon off;'</span>

</code></pre></div></div>

<p>Finally we update the <code class="highlighter-rouge">Dockerfile</code> to add the new assets and ensure the <code class="highlighter-rouge">start.sh</code> script is invoked at container start.</p>

<pre><code class="language-Docker">FROM jekyll/jekyll:3.8.3 AS build

... OMITTED ...

FROM nginx:1.15.3
COPY --from=build /build/_site /usr/share/nginx/html

### copy wrappers and configuration template
COPY nginx/default.conf /etc/nginx/conf.d/mysite.template
COPY nginx/start.sh /usr/bin

CMD ["start.sh"]
</code></pre>

<p>This was the hard part, our image is ready. You can test your image locally. For example on port <code class="highlighter-rouge">8081</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Docker build -t blog .
Docker run -e PORT=8080 -p 8081:8080 blog
</code></pre></div></div>

<h3 id="publish-the-image-to-google-cloud">Publish the image to Google Cloud</h3>

<p>You can publish the Docker image to the <code class="highlighter-rouge">gcr.io</code> registry by building locally and push the Docker image. Or by using Google Cloud Build to build the container. We use the power of the cloud and let Goolge build the image.</p>

<p><code class="highlighter-rouge">gcloud builds submit --tag gcr.io/&lt;project-id&gt;/blog</code></p>

<asciinema-player src="/assets/2019-04-18_cloudrun/build.json" cols="180" rows="15" autoplay="true" loop="true" speed="2.5">
</asciinema-player>

<p>This will build the Docker image in Googleâ€™s cloud build and push it to the registry.</p>

<h3 id="deploy-the-blog">Deploy the blog</h3>

<p>Finally we have to deploy the service via cloud run. You can do this via the web interface, or via the cli.</p>

<p><a href="#">
    <img src="/assets/2019-04-18_cloudrun/cloudrun.png" alt="Model" />
</a></p>

<p>In the web interface it is straightforward to deploy to Cloud Run. In the cli it is not hard bu you need te be aware that cloud run is beta which requires to install the beta components.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud components install beta
</code></pre></div></div>
<p>Next you specify the same properties as you should do via the web interface. Currently Cloud Run is only available in the region <code class="highlighter-rouge">us-central1</code>. Since we run a public site we allow unauthenticated traffic.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud beta run deploy blog \
  --image gcr.io/&lt;project-id&gt;/blog:latest \
  --region us-central1 --allow-unauthenticated
</code></pre></div></div>

<asciinema-player src="/assets/2019-04-18_cloudrun/deploy.json" cols="180" rows="15" autoplay="true" loop="true" speed="2.5">
</asciinema-player>

<h2 id="some-final-thoughts">Some final thoughts</h2>

<p>The first impression is that Cloud Run is quit easy to set up. Good to mention is that is based on the Open Source project <a href="https://github.com/knative/">Knative</a>. At the moment the feature is in beta and there is no support in other regions.</p>

<p>The post shows just a very basic setup</p>

<p>In this post we show just the basics of CLoud Run. It is really super easy to deploy you docker containers to the cloud for low costs. Could be handy for example to review branches. But there is a lot more, containers can be protected and only accept authenticated traffic. Furthermore with integration to Cloud Build it is easy to setup a CI/CD pipeline for <a href="https://github.com">GitHub</a>, <a href="https://bitbucket.org">Bitbucket</a> and Cloud Source Repository. With <a href="https://gitlab.com">GitLab CI</a> setting up a pipeline for Cloud Run is almost a no brainer. And for deployment GitLab already supports Knative to deploy to a Kubernetes cluster.</p>



                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2019/04/02/react-native-navigation-and-clojurescript/" data-toggle="tooltip" data-placement="top" title="React Native Navigation and ClojureScript">&larr; Previous Post</a>
                    </li>
                    
                    
                </ul>

            </div>
        </div>
    </div>
</section>




<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://www.linkedin.com/in/niekpalm">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/niekos77">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/npalm">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul> -->
                <p class="copyright text-muted">Copyright &copy; 040 Code 2019</p>
            </div>
        </div>
    </div>
</footer>

<!-- Disqus -->



<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-97020149-1', 'auto');
  ga('send', 'pageview');

</script>



</body>

</html>
