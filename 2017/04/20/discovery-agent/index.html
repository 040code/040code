<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A developers blog">

    <title>Discover the exposed port - 040 Code</title>

    <link rel="canonical" href="https://040code.github.io//2017/04/20/discovery-agent/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="https://040code.github.io//feed.xml" title="040 Code" />

    


</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">040 Code</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                  
                  <li>
                      <a href="/author/niek/">Niek Palm</a>
                  </li>


                  
                
                  
                  <li>
                      <a href="/author/maarten/">Maarten Metz</a>
                  </li>


                  
                
                  
                  <li>
                      <a href="/author/jeroen/">Jeroen Knoops</a>
                  </li>


                  
                
            </ul>

        </div>


        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    



<!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/silly-walk-this-way-dommeltunnel.png')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Discover the exposed port</h1>
                    
                    <h2 class="subheading">Enabling discovery for Spring Cloud on AWS ECS</h2>
                    
                    <span class="meta">Posted by:
                      
                          <a href="/author/niek/">
                            Niek Palm
                          </a>
                          
                      
                      <!-- 040 Code on April 20, 2017</span> -->
                </div>
            </div>
        </div>
    </div>
</header>



<!-- Post Content -->
<section>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">


        <a class="badge " href="/blog/tag/docker/">Docker</a><a class="badge " href="/blog/tag/aws/">Amazon</a><a class="badge " href="/blog/tag/spring/">Spring Framework</a>


				<p>This post describes a solution for implementing the discovery of the unknown exposed port by a <a href="https://www.docker.com/">Docker</a> container. A specific situation where the problem occurs is when you deploy <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a> micro services as <a href="https://aws.amazon.com/ecs/">Amazon ECS</a> services to the cloud.</p>

<h3 id="the-problem">The problem</h3>
<p>Setting up a micro services architecture requires that there is a way services can find each other. Spring Cloud provides a services discovery service out of the box: Eureka. Services running in the micro services landscape are responsible to register themselves to the discovery service. Then, any service running in the micro services landscape can locate them based on their name. Deploying those services to a docker based cloud, such as AWS, does however create some difficulties.</p>

<p>A service running in a container does not know the external exposed port. The port map can be fixed, for example by mapping the external port on the same port as the internal one but this will eventually cause port conflicts. Besides that, you are not able to scale the container on the same host. Therefore, it make sense to use automatic port assignment. But in that case, services must be able to discover the port, assigned by docker, for registration.</p>

<p>Running micro services in docker containers on AWS ECS looks as follows.</p>

<p><a href="#">
    <img src="/img/ecs1.png" height="80%" width="80%" alt="ECS" />
</a></p>

<p>Each micro service is defined as task which will run as service (a docker container). The docker container runs on a Amazon EC2 instance that also runs docker agent to manage the cluster. Unfortunately, the agent has no API to lookup the exposed port.</p>

<h3 id="solution">Solution</h3>
<p>To lookup the exposed port an extra agent is added to the EC2 instance. The <a href="https://github.com/npalm/docker-discovery-agent">discovery agent</a> uses an API to discover the port for a given container id, internal port and protocol. The only drawback is that the discovery agent needs access to the docker socket which is a potential security risk.</p>

<p><a href="#">
    <img src="/img/ecs2.png" height="100%" width="100%" alt="ECS" />
</a></p>

<p>Let’s explain the working of the discovery agent by example: First we have to start the agent as a docker container.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker run -d -v /var/run/docker.sock:/var/run/docker.sock \
  --name docker-discovery-agent -p 5555:8080 npalm/docker-discovery-agent:1.0.0
</code></pre>
</div>
<p>Now the agent is running, it can be tested. For testing we start another container, remember the problem is that we need to find the exposed port from <strong>within</strong> a container. The local ip address will be added as extra host to the container. The test container is just a linux (CentOS) container containing the tool <code class="highlighter-rouge">curl</code> and for which port 80 is exposed to a random port.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>export DOCKERHOST=$(ifconfig | grep -E "([0-9]{1,3}\.){3}[0-9]{1,3}" | \
  grep -v 127.0.0.1 | awk '{ print $2 }' | cut -f2 -d: | head -n1)
docker run -it -p 80 --add-host="dockerhost:$(DOCKERHOST)" --rm centos /bin/bash
</code></pre>
</div>
<p>We are now in the shell of the CentOS container, the host file contains a DNS entry that points to the host. First, we have to search for the id of the current container.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CONTAINER_ID=$(cat /proc/self/cgroup | grep "cpu:/" | sed 's/\([0-9]\):cpu:\/docker\///g')
</code></pre>
</div>
<p>Then, we ask the discovery agent for our external mapped port by sending the container id and the internal port.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>curl "http://dockerhost:5555/container/${CONTAINER_ID}/portbinding?port=80&amp;protocol=tcp"
</code></pre>
</div>
<p>The result is a JSON string container with the hostIp and hostPort, for example:</p>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="nt">"HostIp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0.0.0"</span><span class="p">,</span><span class="w">
	</span><span class="nt">"HostPort"</span><span class="p">:</span><span class="w"> </span><span class="s2">"32779"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<p>Alternative to passing the host ip address, it is possible to register a static ip address and use this to find the dicovery agent.</p>
<div class="highlighter-rouge"><pre class="highlight"><code>sudo ifconfig lo0 alias 172.16.123.1
</code></pre>
</div>

<p>Now we can discover the exposed port, let’s give some direction on how this can be combined with Spring Cloud on ECS. First deploy Eureka (service discover) as container. Register an ALB (internal) to the service. Now we have an endpoint that we can use to inject the service that needs to register itself. Next create a spring service that is aware of discovery. Before the services can be started, the exposed port needs to be found. Add the snippet below to the start script to start the services in the container.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">export </span><span class="nv">DOCKER_HOST</span><span class="o">=</span><span class="k">$(</span>curl -s 169.254.169.254/latest/meta-data/local-ipv4<span class="k">)</span>
<span class="nb">export </span><span class="nv">CONTAINER_ID</span><span class="o">=</span><span class="k">$(</span>cat /proc/self/cgroup | grep <span class="s2">"cpu:/"</span> | <span class="se">\</span>
  sed <span class="s1">'s/\([0-9]\):cpu:\/docker\///g'</span><span class="k">)</span>
<span class="nb">export </span><span class="nv">NETWORK_BINDING</span><span class="o">=</span><span class="se">\</span>
  <span class="k">$(</span>curl <span class="s2">"http://</span><span class="k">${</span><span class="nv">DOCKER_HOST</span><span class="k">}</span><span class="s2">:5555/container/</span><span class="k">${</span><span class="nv">CONTAINER_ID</span><span class="k">}</span><span class="s2">/portbinding?port=8080&amp;protocol=tcp"</span><span class="k">)</span>
<span class="nb">export </span><span class="nv">EXPOSED_PORT</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">NETWORK_BINDING</span><span class="k">}</span> | jq -c <span class="s1">'.[0].HostPort'</span> | <span class="se">\</span>
  sed -e <span class="s1">'s/^"//'</span>  -e <span class="s1">'s/"$//'</span><span class="k">)</span>

<span class="nb">exec </span>java -jar /service.jar
</code></pre>
</div>
<p>The last step is to update the <code class="highlighter-rouge">application.yml</code> and add a few lines to force the ip address and port during service registration.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>eureka:
  client:
    serviceUrl:
      defaultZone: ${EUREKA_URL} // Needs to be injected as environment variable
  instance:
    preferIpAddress: true
    ip-address: ${DOCKER_HOST}
    non-secure-port: ${EXPOSED_PORT}
</code></pre>
</div>

<h3 id="alternatives">Alternatives</h3>
<p>Discovery of the unknown exposed port is a highly discussed topic and there are many alternative solutions, Please see <a href="https://github.com/docker/docker/issues/3778">docker issue</a>, which is a good starting point for alternatives. The following alternatives came to my mind:</p>
<ul>
  <li>Same approach, but run the discovery service directly on the host.</li>
  <li>Implement the discovery capability in each servie as a library, but the drawback is that all the services need the docker socket.</li>
  <li>Choose another discovery mechanism for example based on ALB.</li>
  <li>Switch to <a href="https://github.com/hashicorp/consul">Consul</a> in combination with a <a href="https://github.com/gliderlabs/registrator">registrator</a></li>
</ul>


                <hr>

                <ul class="pager">
                    
                    
                    <li class="next">
                        <a href="/2017/04/21/gitlab-perodic-build/" data-toggle="tooltip" data-placement="top" title="Periodic builds in GitLab">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</section>




<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://www.linkedin.com/in/niekpalm">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/niekos77">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/npalm">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul> -->
                <p class="copyright text-muted">Copyright &copy; 040 Code 2017</p>
            </div>
        </div>
    </div>
</footer>

<!-- Disqus -->



<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-97020149-1', 'auto');
  ga('send', 'pageview');

</script>



</body>

</html>
