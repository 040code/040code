<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A developers blog">

    <title>Periodic builds in GitLab - 040 Code</title>

    <link rel="canonical" href="https://040code.github.io//2017/04/21/gitlab-perodic-build/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="https://040code.github.io//feed.xml" title="040 Code" />

    

    


</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">040 Code</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                  
                  <li>
                      <a href="/author/niek/">Niek Palm</a>
                  </li>


                  
                
                  
                  <li>
                      <a href="/author/maarten/">Maarten Metz</a>
                  </li>


                  
                
                  
                  <li>
                      <a href="/author/jeroen/">Jeroen Knoops</a>
                  </li>


                  
                
            </ul>

        </div>


        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    



<!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/lichtjesroute.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Periodic builds in GitLab</h1>
                    
                    <h2 class="subheading">Trigger builds based on a crontab</h2>
                    
                    <span class="meta">Posted by:
                      
                          <a href="/author/niek/">
                            Niek Palm
                          </a>
                          
                      
                      on 2017-04-21</span>
                </div>
            </div>
        </div>
    </div>
</header>



<!-- Post Content -->
<section>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">


        <a class="badge " href="/blog/tag/gitlab/">GitLab</a><a class="badge " href="/blog/tag/docker/">Docker</a>


				<p>I am using GitLab CI now for more than a year and I really love the features in GitLab. GitLab provides a complete and powerful tool for day to day development. And of course, there are always feature that you miss. Until now there is no support for periodic builds, in the coming release the <a href="https://gitlab.com/gitlab-org/gitlab-ce/issues/2989">feature</a> will be shipped as experimental feature and in the next one is should be general available. But in case you must deal for some reason with an older version, a work around is described below as I used last year.</p>

<p>You could argue why you should need a feature as a periodic build. Ideally a build should be immutable and only trigger by a change in GIT, a commit. But the world is not always perfect, project build are sometime not of the quality that you are expect or tools are not that reliable as you hope. For example, dependencies resolving could break over the time, to avoid you find the problem once your boss is watching you when fixing a critical bug, a periodic build can alert you earlier. Another and much better reason to argue for the feature is that the GitLab build are so powerful that is handy to use them for a scenario based health check.</p>

<h2 id="the-build-trigger">The build trigger</h2>
<p>To setup a periodic build you first need to be able to trigger a build in some way. GitLab provides an <a href="https://docs.gitlab.com/ce/ci/triggers/">API</a> to trigger a build. Setting up the trigger is simple and complete guided in GitLab, just execute the steps below:</p>

<ul>
  <li>Go to your GitLab projects</li>
  <li>Navigate to Settings -&gt; CI/CD Pipelines</li>
  <li>Scroll down to the trigger section and create a trigger</li>
  <li>Make a note of the TOKEN and trigger URL. An curl example for trigger is shown as well.</li>
</ul>

<p><a href="#">
    <img src="/img/gitlabtrigger.png" alt="GitLab trigger" />
</a></p>

<p>Next we test that we are able to trigger the build remotely be executing the <code class="highlighter-rouge">curl</code> command below.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -X POST \
     -F token=&lt;TOKEN&gt; \
     -F ref=&lt;REF_NAME&gt; \
     &lt;URL&gt;
</code></pre></div></div>
<p>Verify in GitLab the build is triggered</p>

<h2 id="periodic-trigger-the-build-in-a-docker-container">Periodic trigger the build in a Docker container</h2>
<p>The next step is to execute the trigger periodic. A standard way of running a job periodic is by defining crontab. We will use a docker container to execute the crontab so we can deploy it anywhere.</p>

<p>I have createe a base docker image containing a script to trigger GitLab by executing a curl command as shown above. The crontab will be copied to the image <code class="highlighter-rouge">ONBUILD</code>. In the crontab we point to the script that can be executed as follow:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>trigger-gitlab.sh -t &lt;token&gt; -r &lt;ref&gt; -u &lt;gitlab_trigger_url&gt;
</code></pre></div></div>
<p>For the sources see <a href="https://github.com/npalm/gitlab-periodic-trigger">npalm/gitlab-periodic-trigger</a> on GitHub.</p>

<p>Now all peaceâ€™s are ready we only have to build our docker image and run it to trigger the build. First, we create a Dockerfile and only extend the base image <code class="highlighter-rouge">npalm/gitlab-periodic-trigger</code>. Create a new directory, and add a Dockerfile with only the line:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM npalm/gitlab-periodic-trigger:1.0.0
</code></pre></div></div>
<p>This image expects a file <code class="highlighter-rouge">gitlabcrontab</code> containing the <a href="https://en.wikipedia.org/wiki/Cron">crontab</a> and will copy it to the image once build. Create a file named <code class="highlighter-rouge">gitlabcrontab</code>, and add one ore more triggers, an example is below.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7)
# |  |  |  |  |
22 11 * * * trigger-gitlab.sh -t &lt;token&gt; -r &lt;ref&gt; -u &lt;gitlab_trigger_url&gt;
</code></pre></div></div>
<p>Now we build the container <code class="highlighter-rouge">docker build -t periodic-trigger .</code> and finally start the container <code class="highlighter-rouge">docker run -d periodic-trigger</code></p>

<p>To enable the feature for your teams you could set up a build to build the docker image as described below and push it automated to an environment.</p>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2017/04/20/discovery-agent/" data-toggle="tooltip" data-placement="top" title="Discover the exposed port">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2017/05/07/docker-multi-stage-builds/" data-toggle="tooltip" data-placement="top" title="Docker Multi Stage Builds">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</section>




<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://www.linkedin.com/in/niekpalm">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/niekos77">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/npalm">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul> -->
                <p class="copyright text-muted">Copyright &copy; 040 Code 2017</p>
            </div>
        </div>
    </div>
</footer>

<!-- Disqus -->



<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-97020149-1', 'auto');
  ga('send', 'pageview');

</script>



</body>

</html>
