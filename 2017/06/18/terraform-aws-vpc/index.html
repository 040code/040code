<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A developers blog">

    <title>Coding a VPC in Terraform - 040 Code</title>

    <link rel="canonical" href="https://040code.github.io//2017/06/18/terraform-aws-vpc/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link type="application/atom+xml" rel="alternate" href="https://040code.github.io//feed.xml" title="040 Code" />

    

    


</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">040 Code</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                  
                  <li>
                      <a href="/author/niek/">Niek Palm</a>
                  </li>


                  
                
                  
                  <li>
                      <a href="/author/maarten/">Maarten Metz</a>
                  </li>


                  
                
                  
                  <li>
                      <a href="/author/jeroen/">Jeroen Knoops</a>
                  </li>


                  
                
            </ul>

        </div>


        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    



<!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/piazza.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Coding a VPC in Terraform</h1>
                    
                    <h2 class="subheading">A terraform module for a VPC with Private Subnets</h2>
                    
                    <span class="meta">Posted by:
                      
                          <a href="/author/niek/">
                            Niek Palm
                          </a>
                          
                      
                      on 2017-06-18</span>
                </div>
            </div>
        </div>
    </div>
</header>



<!-- Post Content -->
<section>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">


        <a class="badge " href="/blog/tag/aws/">Amazon</a><a class="badge " href="/blog/tag/terraform/">Terraform</a>


				<p>One of the common uses network setups in AWS is called <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Scenario2.html">Scenario 2: VPC with Public and Private Subnets</a>. This is a that defines a Virtual Private Cloud (VPC), public subnets and private subnets. Setting up this infrastructure can be done via the AWS console or via cloud formation scripting. However, I prefer the tool <a href="https://www.terraform.io/">Terraform</a> in which you can manage your infrastructure as code with a declarative language that supports building, changing and versioning your cloud in a modular way.</p>

<p>In this article I will describe how you can create a VPC with a public and private subnet on AWS using terraform. I will describe the setup step by step and I will show how to encapsulate all logic to one re-usable module.</p>

<blockquote>
  <p><a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Subnets.html">Why we need subnets.</a> When you create a VPC, it spans all the Availability Zones in the region. After creating a VPC, you can add one or more subnets in each Availability Zone. When you create a subnet, you specify the CIDR block for the subnet, which is a subset of the VPC CIDR block. Each subnet must reside entirely within one Availability Zone and cannot span zones. Availability Zones are distinct locations that are engineered to be isolated from failures in other Availability Zones. By launching instances in separate Availability Zones, you can protect your applications from the failure of a single location.</p>
</blockquote>

<p>Before you can start, you need an AWS account with sufficient rights (admin), and you should create a <code class="highlighter-rouge">AWS_ACCESS_KEY_ID</code> and <code class="highlighter-rouge">AWS_SECRET_ACCESS_KEY</code> to be able to access your account programmatically.</p>

<h2 id="setting-up-your-system">Setting up your system.</h2>
<p>The easiest way to use terraform is via docker. In that case you do not need any locally isntalled tools. We simply create a file called <code class="highlighter-rouge">.aws</code> where we put the AWS key and secret to athentication API calls, as shown below:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AWS_ACCESS_KEY_ID=&lt;KEY&gt;
AWS_SECRET_ACCESS_KEY=&lt;SECRET&gt;
</code></pre></div></div>

<h2 id="creating-a-vpc-part-1">Creating a VPC part 1</h2>
<p>All code for part 1 is available on <a href="https://github.com/040code/blog_terraform-aws-vpc">github</a></p>

<p>By default, terraform expects the configuration in a file called <code class="highlighter-rouge">main.tf</code>. Create the file and add the terraform provide for Amazon:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># main.tf
provider "aws" {
  region = "eu-west-1"
}
</code></pre></div></div>
<p>We are now ready to, step-by-step, add the terraform resources to create the VPC setup. First, have a look on the VPC setup as shown in the picture below.
<a href="#">
    <img src="/img/nat-gateway-diagram.png" alt="nat-gateway-diagram" />
</a></p>

<p>We will start by creating the VPC itself: add the following snippet to your <code class="highlighter-rouge">main.tf</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource "aws_vpc" "vpc" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_support   = true
  enable_dns_hostnames = true

  tags {
    label = "blog"
  }
}
</code></pre></div></div>
<p>Before we make the change effective we run a <code class="highlighter-rouge">terraform plan</code> to inspect the planned changes. You can install terraform locally or run the commands in a docker container. The docker command will export the AWS credentials to the container, mount the current directory to <code class="highlighter-rouge">/data</code> in the container, and set <code class="highlighter-rouge">/data</code> as working directory to ensure the container will execute the <code class="highlighter-rouge">terraform plan</code> command on the directory that contains the terraform files.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -it --env-file ./.aws  -v $(pwd):/data -w /data \
  hashicorp/terraform:0.9.8 plan
</code></pre></div></div>
<p>After executing the plan command, you should see output similar to:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+ aws_vpc.vpc
    assign_generated_ipv6_cidr_block: "false"
    cidr_block:                       "10.0.0.0/16"
    default_network_acl_id:           "&lt;computed&gt;"
    default_route_table_id:           "&lt;computed&gt;"
    default_security_group_id:        "&lt;computed&gt;"
    dhcp_options_id:                  "&lt;computed&gt;"
    enable_classiclink:               "&lt;computed&gt;"
    enable_dns_hostnames:             "true"
    enable_dns_support:               "true"
    instance_tenancy:                 "&lt;computed&gt;"
    ipv6_association_id:              "&lt;computed&gt;"
    ipv6_cidr_block:                  "&lt;computed&gt;"
    main_route_table_id:              "&lt;computed&gt;"
    tags.%:                           "1"
    tags.label:                       "blog"


Plan: 1 to add, 0 to change, 0 to destroy.
</code></pre></div></div>
<p>This looks correct, so we can apply the change to create the VPC by running <code class="highlighter-rouge">terraform apply</code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -it --env-file ./.aws  -v $(pwd):/data -w /data \
  hashicorp/terraform:0.9.8 apply
</code></pre></div></div>

<p>You can go VPC via the AWS console, where you should now see a VPC in the list named <code class="highlighter-rouge">blog</code>. Now we have the VPC, we create a public and private subnet by adding the following to the main.tf.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource "aws_subnet" "public_subnet_a" {
  vpc_id                  = "${aws_vpc.vpc.id}"
  cidr_block              = "10.0.0.0/24"
  availability_zone       = "eu-west-1a"
  map_public_ip_on_launch = false

  tags {
    Name = "blog"
  }
}

resource "aws_subnet" "private_subnet_a" {
  vpc_id                  = "${aws_vpc.vpc.id}"
  cidr_block              = "10.0.1.0/24"
  availability_zone       = "eu-west-1a"

  tags {
    Name = "blog"
  }
}
</code></pre></div></div>
<p>Run now <code class="highlighter-rouge">terraform plan</code> again, it will show that the resources will be added, one for each subnet. Apply the change using <code class="highlighter-rouge">terraform apply</code> and inspect your changes again via the VPC section in the AWS console.</p>

<p>Next, we connect the public subnet via an <em>internet gateway</em>. Create a routing table and an internet gateway. And a <em>aws_route_table_association</em> to create an association between a subnet and routing table. Update your <code class="highlighter-rouge">main.tf</code> with the snippet below, and run a plan and apply.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource "aws_internet_gateway" "internet_gateway" {
  vpc_id = "${aws_vpc.vpc.id}"
}

resource "aws_route_table" "public_routetable" {
  vpc_id = "${aws_vpc.vpc.id}"

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = "${aws_internet_gateway.internet_gateway.id}"
  }

  tags {
    label = "blog"
  }
}

resource "aws_route_table_association" "public_subnet_a" {
  subnet_id      = "${aws_subnet.public_subnet_a.id}"
  route_table_id = "${aws_route_table.public_routetable.id}"
}

</code></pre></div></div>

<p>We are now able to deploy an application to the public subnet and make it accessible via a security group. However, it is not yet possible to route traffic to the private subnet or let instances on the private subnet connect to internet. To do so, we add a NAT gateway and connect the gateway via a route table to the private subnet. The NAT gateway requires an elastic IP, which we will create first. Add the next terraform snippet to your <code class="highlighter-rouge">main.tf</code> and run a <code class="highlighter-rouge">plan</code> and <code class="highlighter-rouge">apply</code> to inspect and make the changes effective.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource "aws_eip" "nat" {
  vpc = true
}

resource "aws_nat_gateway" "nat" {
  allocation_id = "${aws_eip.nat.id}"
  subnet_id     = "${aws_subnet.public_subnet_a.id}"
}

resource "aws_route_table" "private_routetable" {
  vpc_id = "${aws_vpc.vpc.id}"

  route {
    cidr_block     = "0.0.0.0/0"
    nat_gateway_id = "${aws_nat_gateway.nat.id}"
  }

  tags {
    label = "blog"
  }
}

resource "aws_route_table_association" "private_subnet_a" {
  subnet_id      = "${aws_subnet.private_subnet_a.id}"
  route_table_id = "${aws_route_table.private_routetable.id}"
}
</code></pre></div></div>

<p>Setting up the VPC with subnets is quite verbose, and imagine then when you must support more availability zones, the code will almost double per zone. So we refactor it to a generic module to support the multiple subnets that are available in a zone.</p>

<h2 id="creating-a-vpc-part-2">Creating a VPC part 2</h2>
<p>I have rewritten the code showed above to a generic module. With this model, it is easy to create a VPC with all availability zones per zone, and private subnets can be enabled on demand.</p>

<blockquote>
  <p><a href="https://www.terraform.io/docs/modules/usage.html">Modules in terraform</a> are self-contained packages of gerraform configurations that are managed as a group. Modules are used to create reusable components, improve organization, and to treat pieces of infrastructure as a black box.</p>
</blockquote>

<p>I will not describe all code in the module again but only will pay attention to the significant changes I made. In the code above the zone, availability zone where hard coded. This will not work in a generic module. A common way to solve this in terraform is by creating a map where a zone is mapped to a list of availability zondes. By passing the zone to the moudle, the module can find out which availability zones there are. A default map is available in the module but can be ovewritten as follow:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>availability_zones = {
  eu-west-1 = ["eu-west-1a", "eu-west-1b", "eu-west-1c"]
}
</code></pre></div></div>
<p>The cdir block in the code show above was hard coded, but terraform contains a function to calculate the cdir block. In the module I use the terraform <a href="https://www.terraform.io/docs/configuration/interpolation.html#cidrsubnet-iprange-newbits-netnum-">function</a> <code class="highlighter-rouge">cidrsubnet()</code> to calculate the cdir block.</p>

<p>Now only one problem needs to be solved in order to create a generic module: how can we create a AWS resource for each element in a list? Do we create subnet or route table association for each availability zone? Or how can we avoid creating a private subnet at all? The solution is to use the <code class="highlighter-rouge">count</code> variable in a module to iterate over the list of availability zones, which is available on my <a href="https://github.com/npalm/tf-aws-vpc.git">github</a>. We can now create a VPC similar to the one above with just a few line of code. Add the following lines to your terraform script to create a VPC.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module "vpc" {
  source = "git::https://github.com/npalm/tf-aws-vpc.git"

  key        = "blog"
  aws_region = "eu-west-1"
}
</code></pre></div></div>
<p>It is possible to overwrite module variables with default to get more control, see the ezample below:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module "vpc" {
  source = "git::https://github.com/npalm/tf-aws-vpc.git"

  key        = "blog"
  aws_region = "eu-west-1"

  create_private_hosted_zone = "false"
  create_private_subnets     = "false"
  cidr_block = "10.0.0.0/16"

  // example to override default availability_zones
  availability_zones = {
    eu-west-1 = ["eu-west-1a", "eu-west-1c"]
  }
}
</code></pre></div></div>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2017/05/20/nextbuild-graphql/" data-toggle="tooltip" data-placement="top" title="GraphQL">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2017/07/01/bezier-in-clojure/" data-toggle="tooltip" data-placement="top" title="Visualising Bézier Curves">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</section>




<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://www.linkedin.com/in/niekpalm">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/niekos77">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="https://github.com/npalm">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul> -->
                <p class="copyright text-muted">Copyright &copy; 040 Code 2019</p>
            </div>
        </div>
    </div>
</footer>

<!-- Disqus -->



<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-97020149-1', 'auto');
  ga('send', 'pageview');

</script>



</body>

</html>
